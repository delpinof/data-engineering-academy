{"paragraphs":[{"text":"import org.apache.spark.sql.{Dataset,Row}\r\nimport org.apache.spark.sql.types.{StructType, StringType, TimestampType, IntegerType, DoubleType}\r\nimport java.util.Calendar\r\nimport java.sql.Timestamp","dateUpdated":"2018-08-23T21:41:08+0000","config":{"tableHide":true,"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import org.apache.spark.sql.{Dataset, Row}\nimport org.apache.spark.sql.types.{StructType, StringType, TimestampType, IntegerType, DoubleType}\nimport java.util.Calendar\nimport java.sql.Timestamp\n"}]},"apps":[],"jobName":"paragraph_1535060029677_-1386800905","id":"20180823-200151_1198247100","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1413","user":"anonymous","dateFinished":"2018-08-23T21:41:09+0000","dateStarted":"2018-08-23T21:41:08+0000"},{"text":"//Schema to parse the json\nval schema = (new StructType).add(\"id\", StringType)\n.add(\"client_id\",StringType).add(\"timestamp\", TimestampType)\n.add(\"product_id\",StringType).add(\"quantity\",IntegerType).add(\"total\",DoubleType)","dateUpdated":"2018-08-23T21:41:08+0000","config":{"tableHide":true,"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"schema: org.apache.spark.sql.types.StructType = StructType(StructField(id,StringType,true), StructField(client_id,StringType,true), StructField(timestamp,TimestampType,true), StructField(product_id,StringType,true), StructField(quantity,IntegerType,true), StructField(total,DoubleType,true))\n"}]},"apps":[],"jobName":"paragraph_1535060029678_-1385646658","id":"20180823-203842_251036642","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1414","user":"anonymous","dateFinished":"2018-08-23T21:41:10+0000","dateStarted":"2018-08-23T21:41:08+0000"},{"text":"//Import the data into DataFrame\r\nval ordersDF = spark.read.schema(schema).json(\"gs://de-training-input/alimazon/200000/client-orders/part_20180820T154648_00000.jsonl.gz\")","dateUpdated":"2018-08-23T21:41:08+0000","config":{"tableHide":true,"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"ordersDF: org.apache.spark.sql.DataFrame = [id: string, client_id: string ... 4 more fields]\n"}]},"apps":[],"jobName":"paragraph_1535060029681_-1376027936","id":"20180823-195629_1181918868","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1415","user":"anonymous","dateFinished":"2018-08-23T21:41:10+0000","dateStarted":"2018-08-23T21:41:10+0000"},{"text":"//Function converts timestamp to day of the week\r\ndef dayOfWeek(t:Timestamp) : Int = {\r\n            val c = Calendar.getInstance()\r\n            c.setTime(t)\r\n            c.get(Calendar.DAY_OF_WEEK)\r\n        }","dateUpdated":"2018-08-23T21:41:08+0000","config":{"tableHide":true,"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"dayOfWeek: (t: java.sql.Timestamp)Int\n"}]},"apps":[],"jobName":"paragraph_1535060029681_-1376027936","id":"20180823-200007_318589196","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1416","user":"anonymous","dateFinished":"2018-08-23T21:41:10+0000","dateStarted":"2018-08-23T21:41:10+0000"},{"text":"//Function converts timestamp to month number\r\ndef getMonth(t:Timestamp) : Int = {\r\n            val c = Calendar.getInstance()\r\n            c.setTime(t)\r\n            c.get(Calendar.MONTH)+1\r\n        }","dateUpdated":"2018-08-23T21:41:08+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"getMonth: (t: java.sql.Timestamp)Int\n"}]},"apps":[],"jobName":"paragraph_1535060029681_-1376027936","id":"20180823-211618_1799232573","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1417","user":"anonymous","dateFinished":"2018-08-23T21:41:11+0000","dateStarted":"2018-08-23T21:41:10+0000"},{"text":"//case class to name the columns and create the DS\ncase class orderRow(id:String,client_id:String, timestamp:java.sql.Timestamp, product_id:String, total:Double)   ","dateUpdated":"2018-08-23T21:41:08+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"defined class orderRow\n"}]},"apps":[],"jobName":"paragraph_1535060029681_-1376027936","id":"20180823-200135_1283897905","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1418","user":"anonymous","dateFinished":"2018-08-23T21:41:11+0000","dateStarted":"2018-08-23T21:41:11+0000"},{"text":"//Create Dataset\r\nval ordersDS = ordersDF.map(row => orderRow(\r\n                row.getAs[String](0),\r\n                row.getAs[String](1),\r\n                row.getAs[Timestamp](2),\r\n                row.getAs[String](3),\r\n                row.getAs[Double](5)\r\n            )\r\n        )","dateUpdated":"2018-08-23T21:41:08+0000","config":{"tableHide":true,"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"ordersDS: org.apache.spark.sql.Dataset[orderRow] = [id: string, client_id: string ... 3 more fields]\n"}]},"apps":[],"jobName":"paragraph_1535060029681_-1376027936","id":"20180823-200223_457808744","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1419","user":"anonymous","dateFinished":"2018-08-23T21:41:11+0000","dateStarted":"2018-08-23T21:41:11+0000"},{"text":"//Function to save to a file in CVS format\r\ndef saveToFile(ds:Dataset[Row],filename:String) = {\r\n            ds.write\r\n        \t   .format(\"com.databricks.spark.csv\")\r\n        \t   .option(\"header\", true)\r\n        \t   .option(\"delimiter\", \",\")\r\n        \t   .save(s\"gs://de-training-output-fherdelpino/assignment-3-tst5/$filename\")\r\n}","dateUpdated":"2018-08-23T21:47:12+0000","config":{"tableHide":true,"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"saveToFile: (ds: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row], filename: String)Unit\n"}]},"apps":[],"jobName":"paragraph_1535060029681_-1376027936","id":"20180823-202120_766480087","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1420","user":"anonymous","dateFinished":"2018-08-23T21:41:12+0000","dateStarted":"2018-08-23T21:41:11+0000"},{"text":"//top10_products_by_gross_sales_$i\nfor (i<- 1 to 7) {\n    saveToFile(\n        ordersDS.filter(r => dayOfWeek(r.timestamp) == i).groupBy(\"product_id\").sum(\"total\").withColumnRenamed(\"sum(total)\",\"gross_sales\").orderBy($\"gross_sales\".desc).limit(10),\n        s\"top10_products_by_gross_sales_$i\"\n        )\n}","dateUpdated":"2018-08-23T21:41:09+0000","config":{"tableHide":false,"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1535060029682_-1374873689","id":"20180823-202701_198085769","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1421","user":"anonymous","dateFinished":"2018-08-23T21:42:09+0000","dateStarted":"2018-08-23T21:41:12+0000"},{"text":"//top10_products_by_orders_$i\nfor (i<- 1 to 7) {\n    saveToFile(\n        ordersDS.filter(r => dayOfWeek(r.timestamp) == i).groupBy(\"product_id\").count().withColumnRenamed(\"count\",\"orders_count\").orderBy($\"orders_count\".desc).limit(10),\n        s\"top10_products_by_orders_$i\"\n        )\n}","dateUpdated":"2018-08-23T21:46:48+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"},"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1535060029682_-1374873689","id":"20180823-203615_1445810839","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1422","user":"anonymous","dateFinished":"2018-08-23T21:42:50+0000","dateStarted":"2018-08-23T21:41:12+0000","results":{"code":"SUCCESS","msg":[]}},{"text":"//top10_customers_by_gross_spending_$i\nfor (i<- 1 to 12) {\n    saveToFile(\n        ordersDS.filter(r => getMonth(r.timestamp) == i).groupBy(\"client_id\").sum(\"total\").withColumnRenamed(\"sum(total)\",\"gross_spending\").orderBy($\"gross_spending\".desc).limit(10),\n        s\"top10_customers_by_gross_spending_$i\"\n        )\n}","dateUpdated":"2018-08-23T21:46:54+0000","config":{"tableHide":false,"editorSetting":{"language":"scala"},"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1535060029682_-1374873689","id":"20180823-204553_1303839300","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1423","user":"anonymous","dateFinished":"2018-08-23T21:43:49+0000","dateStarted":"2018-08-23T21:42:09+0000"},{"text":"\n//top10_customers_by_orders_$i\nfor (i<- 1 to 12) {\n    saveToFile(\n        ordersDS.filter(r => getMonth(r.timestamp) == 1).groupBy(\"client_id\").count().withColumnRenamed(\"count\",\"orders_count\").orderBy($\"orders_count\".desc).limit(10),\n        s\"top10_customers_by_orders_$i\"\n        )\n}","dateUpdated":"2018-08-23T21:41:09+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1535060029682_-1374873689","id":"20180823-212021_345777366","dateCreated":"2018-08-23T21:33:49+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1424","user":"anonymous","dateFinished":"2018-08-23T21:44:43+0000","dateStarted":"2018-08-23T21:42:51+0000"},{"dateUpdated":"2018-08-23T21:33:49+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1535060029683_-1375258438","id":"20180823-212601_31790638","dateCreated":"2018-08-23T21:33:49+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:1425"}],"name":"AlimazonC3","id":"2DRMEUVB9","angularObjects":{"2DNKYS9A7:shared_process":[],"2DQCWKX5R:shared_process":[],"2DN66H2S9:shared_process":[],"2DNFGRKRE:shared_process":[],"2DR97JNHF:shared_process":[],"2DNQBURZ9:shared_process":[],"2DPBZU179:shared_process":[],"2DNSVWDTF:shared_process":[],"2DQ54CDPD:shared_process":[],"2DNNW6U5P:shared_process":[],"2DPEHYM74:shared_process":[],"2DPT4ECED:shared_process":[],"2DNDX1VKA:shared_process":[],"2DNAA7YCZ:shared_process":[],"2DRG2SA38:shared_process":[],"2DQWV9598:shared_process":[],"2DR5YWSSV:shared_process":[],"2DNSD7N1U:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}